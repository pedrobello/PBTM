---
title: "The PBTM R-Package"
Author: "Pedro Bello and Kent Bradford"
output:
  rmarkdown::html_document:
    theme: paper 
    highlight: tango
    toc: true
    toc_float: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width=7, fig.height=5) 
```

<p style="text-align: left;"><big>Pedro Bello and Kent Bradford</big></p>


## Overview
#### Population-based Threshold Models (PBTM) Calculator - beta version. 
This R package combines existing PBTMs calculation, parameters output and respective plots. 

## Installation 
Installation of the package requires the "devtools" package. 

#### Install development version from Github
```{r warning=FALSE, message=FALSE, results='hide', eval=FALSE}
devtools::install_github("pedrobello/PBTM")
```

#### Load package
```{r warning=FALSE, message=FALSE, results='hide', eval=FALSE}
library("PBTM")
```

## Data preparation steps

Before using the PBTM package, data preparation and selection is required. Main steps are described below.

*    Download the template file (download <a href="https://raw.githubusercontent.com/pedrobello/PBTM/master/data/PBTM-R-Dt-Empty.csv" download> PBTM-R-Dt-Empty.csv </a> or the example file <a href="https://raw.githubusercontent.com/pedrobello/PBTM/master/data/PBTM-R-Dt-Sample.csv">PBTM-R-Dt-Sample.csv</a>).
*    Enter your data in the proper field and leave unsed columns in blank. Repeat the treatment information for all data points of that treatment. Description of all fields present in the template file in the table below.

```{r include=FALSE}
library(knitr)
library("PBTM")
library(dplyr)
library(kableExtra)
```

```{r echo=FALSE}
data(DatasetDesc)
kable(DatasetDesc) %>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "200px")

```

<br>

* Inform your working folder in R. Add the folder location of your data files.
```{r warning=FALSE, message=FALSE, results='hide', eval=FALSE}
setwd("~/MyProjectFolder/MyDataFolder")
```
* Load Seeds data - Add the name of the data file (csv file)
```{r warning=FALSE, message=FALSE, results='hide', eval=FALSE}
mydata <- read.csv("PBTM-R-Data-MyData.csv", header=T)
```
* In case the data file has more treatments than you wish to use on a partiular model calculation, filter only the data that will be used to calculate that particular model.
Some examples:
    + Thermal time model: Select only treatments with germination tested in water (wp = 0) for a particular seed lot (Treat.ID = 1)
      ```{r warning=FALSE, message=FALSE, results='hide', eval=FALSE}
      TreatData <- subset(mydata, Treat.ID == 1 & Germ.wp==0)
      ```
    + Hydrotime model: Select only treatments with germination tested in a certain temperature (temp = 25C) for a particular seed lot (Treat.ID = 1)
      ```{r warning=FALSE, message=FALSE, results='hide', eval=FALSE} 
      TreatData <- subset(mydata, Treat.ID == 1 & Germ.temp==25)
      ```
    + Hydrothermal time suboptimal model: Select only treatments with germination tested in a certain temperature range (temp < 26C) for a particular seed lot (Treat.ID = 1)
      ```{r warning=FALSE, message=FALSE, results='hide', eval=FALSE} 
      TreatData <- subset(mydata, Treat.ID == 1 & Germ.temp < 26)
      ```
*    Whenever the data file is already filtered only with the data to be used in the model calculation, reference the filtered data to the TreatData data table (step already perfomed above when data filtering is required).
```{r warning=FALSE, message=FALSE, results='hide', eval=FALSE}
TreatData <- mydata
```

## Model Selection 

After the data to be used in the model calculation is passed to the TreatData table, now define the model to be calculated. Currently, the following models are available for calculation:

```{r echo=FALSE}
data(Models)
kable(x = Models, format = "html", align = "c") %>%
  kable_styling() %>%
  column_spec(2, width = "17em", bold = T) %>%
  scroll_box(width = "100%", height = "400px")
```
<br>

The model is selected using the function "DefineModel()" with the respective code of the model as described above. Examples below.

Selection of the thermal time suboptimal model:
```{r warning=FALSE, message=FALSE, results='hide', eval=FALSE}
DefineModel(1.1)
```
Selection of the hydrothermal time suboptimal model:
```{r warning=FALSE, message=FALSE, results='hide', eval=FALSE}
DefineModel(3.1)
```

## Basic Functions

### PlotRawData()
Plot your raw data to be used on model. Cumulative germination (or other measured signal) curves will be plotted against time in hours. Treatments legend will be created based on the selected model. The data to be used on the models and plotted here must be referenced to the **TreatData** data table.  

```{r warning=FALSE}
data(TomatoQ2Dt)
TreatData <- subset(TomatoQ2Dt, Treat.ID == 1 & Germ.wp==0)
DefineModel(1.1)
PlotRawData()
```
<br>
Example of raw data for the thermal time model. Population oxygen depletion (POD) curves for tomato seeds at suboptimal temperatures (25, 20 and 15C). Bello and Bradford (2016) Seed Science Research 26(3) 199–221. 

### CalcT50nGR50()

Calculates the time to 50% germination (T50) and the germination rate (GR50) and separates the treatments based on the TreatData file. Treatments and calculated parameters are delivered to the **Treatments** data file. 

```{r warning=FALSE}
CalcT50nGR50()
```

```{r echo=FALSE}
kable(Treatments[c(1:2,7:8,11:12)], format = "html", align = "c")
```
<br>

### CleanGermData()

Clean repetitive percentages on the cumulative curves to be used in the selected models. Data present of the **TreatData** file is processed (it keeps only initial germination observation and remove points where no increase was observed). This function sends the clean and processed data to the **TreatDataClean** data file and plots the result.

```{r warning=FALSE, message=FALSE, results='hide', eval=FALSE}
CleanGermData()
```

## Model Calculation and plot

The Function **CALCnPLOTModel()** calculates model parameters and plot raw and curves predicted by the selected model. Additionaly, model parameters and correlations values are informed in the plot. 

### Thermal time suboptimal model
```{r warning=FALSE, message=FALSE, results='hide'}
TreatData <- subset(TomatoQ2Dt, Treat.ID == 1 & Germ.wp==0)
DefineModel(1.1)
```

```{r warning=FALSE}
CALCnPLOTModel()
```
<br>
Example of calculated thermal time model with raw data, predicted curves and calculated parameters. Bello and Bradford (2016) Seed Science Research 26(3) 199–221. 

### Hydrotime suboptimal model
```{r warning=FALSE, message=FALSE, results='hide'}
TreatData <- subset(TomatoQ2Dt, Treat.ID == 1 & Germ.temp==25)
DefineModel(2.1)
```

```{r warning=FALSE}
CALCnPLOTModel()
```
<br>
Example of calculated hydrotime model at 25C with raw data, predicted curves and calculated parameters. Bello and Bradford (2016) Seed Science Research 26(3) 199–221. 

### Hydrotime supra-optimal model
```{r warning=FALSE, message=FALSE, results='hide'}
TreatData <- subset(TomatoQ2Dt, Treat.ID == 1 & Germ.temp==25)
DefineModel(2.1)
```

```{r warning=FALSE}
CALCnPLOTModel()
```
<br>
**Example of calculated hydrotime model at 25C with raw data, predicted curves and calculated parameters. Bello and Bradford (2016) Seed Science Research 26(3) 199–221.CHANGE**

### Hydrothermal time suboptimal model
```{r warning=FALSE, message=FALSE, results='hide'}
TreatData <- subset(TomatoQ2Dt, Treat.ID == 1)
DefineModel(3.1)
```

```{r warning=FALSE}
CALCnPLOTModel()
```
<br>
Example of calculated hydrothermal time model with raw data, predicted curves and calculated parameters. Bello and Bradford (2016) Seed Science Research 26(3) 199–221. 

### Hydropriming model
```{r warning=FALSE, message=FALSE, results='hide'}
data(PrimingDt)
TreatData <- subset(PrimingDt, Treat.priming.temp == 20 | Treat.priming.temp == 0)
DefineModel(6.1)
```

```{r include=FALSE}
PlotRawData()
knitr::opts_chunk$set(fig.width=9, fig.height=4) 
```

```{r warning=FALSE}
CALCnPLOTModel()
```
<br>
Example of calculated hydropriming model with raw data (left panel) and germination rates (GR50) relationship with hydropriming time (right panel).

### Hydrothermal priming model
```{r warning=FALSE, message=FALSE, results='hide'}
TreatData <- PrimingDt
DefineModel(6.2)
```

```{r include=FALSE}
PlotRawData()
```

```{r warning=FALSE}
CALCnPLOTModel()
```
<br>
Example of calculated hydrothermal priming model with raw data (left panel) and germination rates (GR50) relationship with hydrothermal priming time (right panel).


